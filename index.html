<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Amertüme — Mini Arbre de Compétences</title>
<style>
  :root{
    --bg:#0b0f14; --grid:#0e1520; --card:#181f2a; --stroke:#0b0f14;
    --node-grey:#a9b0b6; --node-green:#3e7a47; --node-teal:#61a7a8; --node-cream:#e8e6de; --node-red:#b94a48;
    --txt:#f0f6ff; --muted:#a8b0bd; --accent:#7dd3fc; --link:#8aa1b6; --link-active:#facc15;
    --shadow:0 8px 24px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial}
  .wrap{max-width:1080px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 12px}
  p.lead{margin:0 0 18px;color:var(--muted)}

  .tree{position:relative; background:linear-gradient(180deg,#0d1420,#0c121a); border:1px solid #1a2434; border-radius:16px; padding:32px; box-shadow:var(--shadow); overflow:hidden}
  .grid-bg{position:absolute; inset:0; background-image: radial-gradient(#111927 1px, transparent 1px); background-size: 18px 18px; opacity:.35; pointer-events:none}

  .node{position:absolute; min-width:220px; max-width:280px; padding:14px 16px; border-radius:16px; border:2px solid #101826; box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
        cursor:pointer; user-select:none; transition: transform .12s ease, filter .12s ease, box-shadow .12s ease}
  .node.small{min-width:120px; max-width:160px; text-align:center}
  .node.grey{background: linear-gradient(#b4bcc3,#9aa3aa); color:#111827}
  .node.green{background: linear-gradient(#4a8d54,#356f3e)}
  .node.teal{background: linear-gradient(#74bdbe,#529a9b)}
  .node.cream{background: linear-gradient(#f3f1ea,#dfddd5); color:#1b2430}
  .node .title{font-weight:800; font-size:18px; line-height:1.1; margin-bottom:4px; text-shadow:0 1px 0 rgba(0,0,0,.35)}
  .node .subtitle{font-weight:700; font-size:16px; text-shadow:0 1px 0 rgba(0,0,0,.35)}
  .node .body{font-weight:700; font-size:17px; text-align:center; text-shadow:0 1px 0 rgba(0,0,0,.35)}
  .node .desc{font-size:13px; opacity:.95}

  .node:hover{transform: translateY(-1px); filter:brightness(1.03)}
  .node.active{outline:3px solid #facc15; box-shadow:0 0 10px rgba(250,204,21,.7),0 0 20px rgba(250,204,21,.4)}
  .node.locked{filter: grayscale(0.65) brightness(0.85); opacity:.85}

  .badge-check{position:absolute; left:-10px; top:-10px; width:26px; height:26px; border-radius:8px; background:#0f1522; border:2px solid #24324a; display:flex; align-items:center; justify-content:center; color:#9fb3c8; font-size:14px; box-shadow:0 4px 10px rgba(0,0,0,.4)}
  .node.active .badge-check{background:#153b2a; border-color:#2d6b4c; color:#bff3d1}
  .badge-points{position:absolute; right:-10px; top:-10px; min-width:30px; height:30px; padding:0 8px; border-radius:10px; background:#24324a; border:2px solid #36465c; display:flex; align-items:center; justify-content:center; color:#f0f6ff; font-size:16px; font-weight:800; box-shadow:0 4px 10px rgba(0,0,0,.4); transition:background .15s ease, border-color .15s ease, color .15s ease} 
  .node.active .badge-points{background:#153b2a; border-color:#2d6b4c; color:#bff3d1}

  svg#links{position:absolute; inset:0; pointer-events:none; filter: drop-shadow(0 2px 0 rgba(0,0,0,.35))}
  .link{stroke: var(--link); stroke-width:3; fill:none; stroke-linecap:round; transition:stroke .2s ease, stroke-width .2s ease}
  .link.active{stroke: var(--link-active); stroke-width:4; filter: drop-shadow(0 0 2px rgba(250,204,21,.6)) drop-shadow(0 0 8px rgba(250,204,21,.25))}

  .tooltip{position:absolute; z-index:5; pointer-events:none; transform:translate(-50%, -110%); background:#101826; color:#dbe6f3; border:1px solid #24324a; border-radius:10px; padding:10px 12px; font-size:13px; box-shadow:0 8px 20px rgba(0,0,0,.35); opacity:0; transition:opacity .12s ease}
  .tooltip .tt-title{font-weight:800; margin-bottom:4px}
  .tooltip.show{opacity:1}

  .legend{margin-top:14px; color:var(--muted); font-size:13px}

  /* Feuille de compétences */
  .sheet{margin-top:16px; background:linear-gradient(180deg,#0d1420,#0c121a); border:1px solid #1a2434; border-radius:16px; padding:16px; box-shadow:var(--shadow)}
  .sheet h2{margin:0 0 8px; font-size:18px}
  .sheet .muted{color:var(--muted); font-size:13px; margin:0 0 12px}

  .stats-section{display:flex; gap:16px; margin-bottom:16px}
  .stat-box{display:flex; align-items:center; background:#121a28; border:2px solid #233149; border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,.35)}
  .stat-label{padding:10px 16px; font-weight:800; font-size:18px; color:#fff}
  .stat-value{background:#fff; color:#000; font-weight:800; font-size:20px; padding:10px 16px; min-width:40px; text-align:center}
  .stat-label.endu{background:#61a7a8;}
  .stat-label.degats{background:#b94a48;}

  .skills-section{margin-bottom:14px}
  .skills-section h3{margin:0 0 8px; font-size:15px; color:var(--accent)}
  .skills-section .counter{font-weight:700; margin-left:6px; padding:2px 8px; border-radius:999px; background:#0f1522; border:1px solid #24324a}
  .skills-list{display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:10px}
  .skill-tag{border-radius:10px; padding:10px 12px; box-shadow:0 2px 6px rgba(0,0,0,.3)}
  .skill-tag .st-title{font-weight:700}
  .skill-tag .st-desc{font-size:12px; margin-top:4px}
  .skill-tag.grey{background: linear-gradient(#b4bcc3,#9aa3aa); border:1px solid #8e98a0; color:#111827}
  .skill-tag.green{background: linear-gradient(#4a8d54,#356f3e); border:1px solid #2d5a3c; color:#e9f7ed}
  .skill-tag.teal{background: linear-gradient(#74bdbe,#529a9b); border:1px solid #467f80; color:#0e1a22}
  .skill-tag.cream{background: linear-gradient(#f3f1ea,#dfddd5); border:1px solid #c9c7be; color:#1b2430}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Amertüme — Arbre de Compétences</h1>
    <p class="lead">L'Alchimiste choisit une spécialisation Apothicaire ou Artificier.</p>
    <div id="points-bar" style="display:flex; align-items:center; gap:10px; margin:8px 0 12px 0;">
      <div style="font-size:14px; color:var(--muted);">Points dépensés :</div>
      <div id="points-counter" style="background:#0f1522; border:1px solid #24324a; color:#e6edf6; font-weight:800; padding:6px 10px; border-radius:10px; min-width:56px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,.25)">0</div>
    </div>

    <div class="tree" id="tree" style="height:470px">
      <div class="grid-bg"></div>
      <button id="btn-reset" style="position:absolute; right:16px; top:16px; z-index:10; background:#0f1522; color:#e6edf6; border:1px solid #24324a; border-radius:10px; padding:8px 12px; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,.35)">Réinitialiser</button>
      <svg id="links" viewBox="0 0 1000 600" preserveAspectRatio="none"></svg>

      <!-- Nœuds -->
      <div class="node grey" id="n1" style="left:60px; top:70px">
        <div class="title">Analyse</div>
        <div class="desc">Sans mouvement, vous effectuez <b>1 analyse standard</b>.</div>
        <div class="badge-check">☑︎</div>
        <div class="badge-points">1</div>
      </div>

      <div class="node green" id="n2" style="left:60px; top:250px">
        <div class="title">Analyses supérieures</div>
        <div class="desc">Débloque des analyses de <b>niveau 2</b>.</div>
        <div class="badge-check">☐</div>
        <div class="badge-points">2</div>
      </div>

      <div class="node teal small" id="n3" style="left:420px; top:70px">
        <div class="subtitle">Endu</div>
        <div class="body">+2</div>
        <div class="badge-check">☐</div>
        <div class="badge-points">1</div>
      </div>

      <div class="node cream small" id="n4" style="left:420px; top:250px">
        <div class="subtitle">Dégâts</div>
        <div class="body">+2</div>
        <div class="badge-check">☐</div>
        <div class="badge-points">1</div>
      </div>

      <div class="node green" id="n5" style="left:780px; top:250px">
        <div class="subtitle">Onde Infusée</div>
        <div class="desc">Vos Infusions appliquent Onde.</div>
        <div class="badge-check">☐</div>
        <div class="badge-points">2</div>
      </div>

      <div id="tooltip" class="tooltip">
        <div class="tt-title">Titre</div>
        <div class="tt-body">Description…</div>
      </div>
    </div>

    <div class="sheet" id="sheet">
      <h2>Feuille de compétences</h2>
      <p class="muted">Résumé en temps réel des compétences <b>débloquées</b>, regroupées par catégorie avec limites.</p>
      <div class="stats-section" id="stats"></div>
      <div id="skills-sections"></div>
    </div>

    <div class="legend">Astuce : maintiens <b>Shift</b> en cliquant pour activer/désactiver plusieurs nœuds sans tenir compte des prérequis.</div>
  </div>

<script>
(function(){
  const $ = (s, r=document)=> r.querySelector(s);
  const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
  const svg = $('#links');

  // Catégories et limites
  const categories = {
    'Actions': 5,
    'Réactions': 4,
    'Passif': 12,
    'Améliorations': 12,
    'Maîtrises': 2,
    'Expertises': 4
  };

  // Définitions des nœuds
  const nodes = [
    { id:'n1', title:'Analyse', text:'Sans mouvement, vous effectuez 1 analyse standard.', req:[], unlock:['n2','n3'], category:'Actions', color:'grey', points:2 },
    { id:'n2', title:'Analyses supérieures', text:'Vous pouvez effectuer des analyses de niveau 2.', req:['n1'], unlock:['n4'], category:'Actions', color:'green', points:2 },
    { id:'n3', title:'Endu +2', text:"Augmente l'Endurance de +2.", req:['n1'], unlock:[], category:'Stat-Endu', color:'teal', points:1 },
    { id:'n4', title:'Dégâts +2', text:'Augmente les dégâts de +2.', req:['n2'], unlock:[], category:'Stat-Dégâts', color:'cream', points:1 },    
    { id:'n5', title:'Onde Infusée', text:'Vos Infusions appliquent Onde.', req:['n4'], unlock:[], category:'Actions', color:'green', points:1 },
  ];

  // Liens visuels
  const links = [
    {from:'n1', to:'n2'},
    {from:'n1', to:'n3'},
    {from:'n2', to:'n4'}
    {from:'n4', to:'n5'}
  ];

  // --------- GÉOMÉTRIE & TRAITS ---------
  function rectOf(el){ const r = el.getBoundingClientRect(); const p = svg.getBoundingClientRect(); return {x:r.left - p.left, y:r.top - p.top, w:r.width, h:r.height}; }
  function pathFrom(a, b){
    const p1 = rectOf(a), p2 = rectOf(b);
    const x1 = p1.x + p1.w/2, y1 = p1.y + p1.h/2;
    const x2 = p2.x + p2.w/2, y2 = p2.y + p2.h/2;
    return { d:`M ${x1},${y1} L ${x2},${y2}` };
  }
  function drawLinks(){
    svg.innerHTML = '';
    links.forEach(({from,to})=>{
      const fromEl = $('#'+from), toEl = $('#'+to);
      if(!fromEl || !toEl) return;
      const {d} = pathFrom(fromEl, toEl);
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', d );
      path.setAttribute('class','link');
      path.dataset.from = from; path.dataset.to = to;
      svg.appendChild(path);
    });
  }
  window.addEventListener('resize', drawLinks);
  drawLinks();

  // --------- ÉTAT & RÈGLES ---------
  const state = new Map(nodes.map(n=>[n.id,false]));
  function meetsReq(id){ const def = nodes.find(n=>n.id===id); return def.req.every(r=> state.get(r)); }
  function updateLocks(){
    nodes.forEach(n=>{
      const el = $('#'+n.id);
      if(!el) return;
      if(!meetsReq(n.id) && !state.get(n.id)) el.classList.add('locked'); else el.classList.remove('locked');
    });
  }
  function updateLinks(){
    $$('.link', svg).forEach(p=>{
      const a = state.get(p.dataset.from);
      const b = state.get(p.dataset.to);
      p.classList.toggle('active', !!(a && b));
    });
  }

  // --------- COMPTEUR DE POINTS ---------
  function totalPoints(){
    return nodes.reduce((sum,n)=> sum + (state.get(n.id)? (n.points||0):0), 0);
  }
  function renderPoints(){
    const el = document.getElementById('points-counter');
    if(el) el.textContent = totalPoints();
  }

  // --------- FEUILLE (CATEGORIES + STATS) ---------
  function renderSheet(){
    renderPoints();
    const container = $('#skills-sections');
    container.innerHTML = '';

    for(const [cat,limit] of Object.entries(categories)){
      const section = document.createElement('div');
      section.className = 'skills-section';
      const actives = nodes.filter(n=> state.get(n.id) && n.category===cat);
      const used = Math.min(actives.length, limit);

      section.innerHTML = `<h3>${cat} <span class="counter">${used}/${limit}</span></h3><div class="skills-list"></div>`;
      const list = section.querySelector('.skills-list');

      actives.slice(0,limit).forEach(n=>{
        const item = document.createElement('div');
        item.className = `skill-tag ${n.color}`;
        item.innerHTML = `<div class="st-title">${n.title}</div><div class="st-desc">${n.text}</div>`;
        list.appendChild(item);
      });
      if(actives.length===0){
        list.innerHTML = '<div class="skill-tag"><div class="st-title">—</div></div>';
      }
      container.appendChild(section);
    }

    // Statistiques (toujours visibles)
    const statsEl = $('#stats');
    const enduCount = nodes.filter(n=> n.category==='Stat-Endu' && state.get(n.id)).length;
    const degatsCount = nodes.filter(n=> n.category==='Stat-Dégâts' && state.get(n.id)).length;
    const endu = enduCount * 2;
    const degats = degatsCount * 2;

    statsEl.innerHTML = `
      <div class="stat-box"><div class="stat-label endu">Endu</div><div class="stat-value">${endu}</div></div>
      <div class="stat-box"><div class="stat-label degats">Dégâts</div><div class="stat-value">${degats}</div></div>
    `;
  }

  // --------- ACTIONS ---------
  function applyActive(id, val){
    const el=$('#'+id);
    state.set(id,val);
    if(el){
      el.classList.toggle('active', !!val);
      const b = $('.badge-check', el); if(b) b.textContent = val? '☑︎' : '☐';
    }
  }
  function pruneDownstream(){
    let changed=true;
    while(changed){
      changed=false;
      nodes.forEach(n=>{
        if(state.get(n.id) && !meetsReq(n.id)){
          applyActive(n.id,false);
          changed=true;
        }
      });
    }
  }
  function setActive(id, val){
    applyActive(id,val);
    if(!val){ pruneDownstream(); }
    updateLocks();
    updateLinks();
    renderSheet();
    renderPoints();
  }

  // Interactions sur les nœuds
  nodes.forEach(n=>{
    const el = $('#'+n.id);
    if(!el) return;
    el.addEventListener('click', (ev)=>{
      const multi = ev.shiftKey; // ignore les prérequis si Shift
      if(!multi && !meetsReq(n.id) && !state.get(n.id)) return; // bloqué si requis non remplis
      setActive(n.id, !state.get(n.id));
    });
  });

  // Bouton Réinitialiser : décoche TOUT, y compris la base
  const resetBtn = $('#btn-reset');
  if(resetBtn){
    resetBtn.addEventListener('click', ()=>{
      nodes.forEach(n=> applyActive(n.id, false));
      updateLocks();
      updateLinks();
      renderSheet();
    renderPoints();
    });
  }

  // --------- INIT ---------
  applyActive('n1', true); // état initial: base active (modifiable si tu préfères vide)
  updateLocks();
  updateLinks();
  renderSheet();
    renderPoints();

  // --------- TOOLTIP ---------
  const tt = $('#tooltip');
  function showTT(el, title, body){
    const r = el.getBoundingClientRect();
    const c = svg.getBoundingClientRect();
    tt.style.left = (r.left + r.width/2 - c.left) + 'px';
    tt.style.top  = (r.top  - 10 - c.top) + 'px';
    $('.tt-title', tt).textContent = title;
    $('.tt-body', tt).textContent  = body;
    tt.classList.add('show');
  }
  function hideTT(){ tt.classList.remove('show'); }
  nodes.forEach(n=>{
    const el = $('#'+n.id);
    if(!el) return;
    el.addEventListener('mouseenter', ()=> showTT(el, n.title, n.text));
    el.addEventListener('mouseleave', hideTT);
  });
})();
</script>
</body>
</html>
